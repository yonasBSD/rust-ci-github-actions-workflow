name: Release Packaging

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write
  id-token: write

jobs:
  release:
    name: Build (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        # Define the OS targets
        include:
          - os: ubuntu-latest
            artifact_ext: '{*.deb,*.apk,*.ipk,*.rpm,*.zst}'
          - os: macos-latest
            artifact_ext: '*.dmg' # Or your preferred Mac format
          - os: windows-latest
            artifact_ext: '*.exe'

    steps:
      - name: Harden Runner
        uses: step-security/harden-runner@e3f713f2d8f53843e71c69a996d56f51aa9adfb9 # v2
        with:
          egress-policy: block
          allowed-endpoints: >
            api.deps.dev:443
            api.github.com:443
            api.osv.dev:443
            api.scorecard.dev:443
            fulcio.sigstore.dev:443
            github.com:443
            uploads.github.com:443
            rekor.sigstore.dev:443
            tuf-repo-cdn.sigstore.dev:443
            www.bestpractices.dev:443
            release-assets.githubusercontent.com:443
            objects.githubusercontent.com:443
            raw.githubusercontent.com:443
            static.rust-lang.org:443
            static.crates.io:443
            index.crates.io:443
            # Windows/Mac specific update mirrors
            *.actions.githubusercontent.com:443
            *.blob.core.windows.net:443

      - uses: actions/checkout@v4

      - name: Derive project names
        shell: bash
        run: |
          CRATE_NAME=$(cargo metadata --no-deps --format-version 1 | jq -r '.packages[0].name')
          echo "PROJECT_BIN=$CRATE_NAME" >> $GITHUB_ENV
          echo "PROJECT_NAME_UNDERSCORE=$(echo "$CRATE_NAME" | tr '-' '_')" >> $GITHUB_ENV

      - name: Release Build
        uses: yonasBSD/toolkit@e3156a095eb4a759778ad8ef10dfd58dd00993e6 # v1.0.0
        with:
          run: |
            cargo auditable build --release

      # NFPM is Linux-centric (deb/rpm/apk).
      # We only run it on Linux to avoid errors on Windows/Mac.
      - name: Create Linux Packages (NFPM)
        if: matrix.os == 'ubuntu-latest'
        shell: bash
        run: |
          VERSION=${{ github.ref_name }}
          sed -i -E "s/^version:.+$/version: ${VERSION#v}/g" packaging/nfpm/nfpm.yaml
          curl -sL https://github.com/goreleaser/nfpm/releases/latest/download/nfpm_$(uname -s)_$(uname -m).tar.gz | tar xz
          for pkg in deb apk archlinux rpm ipk; do
            ./nfpm package --config packaging/nfpm/nfpm.yaml --packager $pkg
          done

      - name: Install Tooling (Multi-platform)
        shell: bash
        run: |
          # Install Cosign
          LATEST_COSIGN=$(curl -sL https://api.github.com/repos/sigstore/cosign/releases/latest | jq -r .tag_name)
          if [[ "${{ matrix.os }}" == "windows-latest" ]]; then
            curl -LO "https://github.com/sigstore/cosign/releases/download/${LATEST_COSIGN}/cosign-windows-amd64.exe"
            mv cosign-windows-amd64.exe cosign.exe
          else
            curl -LO "https://github.com/sigstore/cosign/releases/download/${LATEST_COSIGN}/cosign-$(uname -s | tr '[:upper:]' '[:lower:]')-amd64"
            chmod +x cosign-* && mv cosign-* /usr/local/bin/cosign || mv cosign-* ./cosign
          fi

      - name: Sign and Checksum
        shell: bash
        run: |
          # Sign everything matching the matrix extension
          for f in ${{ matrix.artifact_ext }}; do
            [ -e "$f" ] || continue
            ./cosign sign-blob --yes --output-signature "$f.sig" "$f" || cosign sign-blob --yes --output-signature "$f.sig" "$f"
          done
          # Simple SHA256 (b3sum isn't always pre-installed on Win/Mac runners)
          shasum -a 256 ${{ matrix.artifact_ext }} > checksums.txt

      - name: Attestations
        uses: actions/attest-artifact@v1
        with:
          subject-path: "${{ matrix.artifact_ext }}"

      - name: Create Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2
        with:
          files: |
            ${{ matrix.artifact_ext }}
            *.sig
            checksums.txt

      - name: Generate SLSA Level 3 Provenance
        uses: actions/attest-build-provenance@92c65d2898f1f53cfdc910b962cecff86e7f8fcc # v1
        with:
          subject-path: "${{ matrix.artifact_ext }}"
